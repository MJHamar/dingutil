#!/bin/bash
# ding-smart — Config-driven notification sound + screen flash
# Used as a Claude Code notification hook.
#
# Usage: ding-smart <PROJECT_ROOT>
#
# Config: ~/.config/dingconfig.json
#   {
#     "sound": true,
#     "blink": true,
#     "default": {
#       "soundfile": "/path/to/sound.wav",
#       "blink_color": "orange"
#     },
#     "/absolute/path/to/project": {
#       "soundfile": "/path/to/custom.wav",
#       "blink_color": "#FF2299"
#     }
#   }
#
# Resolution: root-level sound/blink booleans control toggles,
# path entry (falling back to "default") provides soundfile + blink_color.

set -euo pipefail

FLASH_BIN="/Users/hamar.miklos/dingutil/flash-border"
DEFAULT_SOUND="/Users/hamar.miklos/dingutil/sounds/mc-villager-huh.wav"
DEFAULT_COLOR="orange"
GLOBAL_CONFIG="$HOME/.config/dingconfig.json"

# Platform-aware sound player
if [[ "$OSTYPE" == "darwin"* ]]; then
    SOUND_PLAYER="afplay"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    SOUND_PLAYER="aplay -q"
else
    SOUND_PLAYER="echo"
fi

# Platform-aware jq path
JQ=$(command -v jq)

# Drain stdin so the hook doesn't hang (Claude pipes JSON here)
cat > /dev/null &

PROJECT_ROOT="${1:-}"
if [ -z "$PROJECT_ROOT" ]; then
    echo "Usage: ding-smart <PROJECT_ROOT>" >&2
    exit 1
fi

# --- Config resolution ---
# Single jq call resolves: global toggles, path→default fallback,
# and explicit "default" values against the default entry.
RESOLVED=$(
    "$JQ" -r \
        --arg key "$PROJECT_ROOT" \
        --arg fallback_sound "$DEFAULT_SOUND" \
        --arg fallback_color "$DEFAULT_COLOR" \
    '
      (if .sound == null then true else .sound end) as $sound |
      (if .blink == null then true else .blink end) as $blink |
      .default          as $def   |
      (.[$key] // $def // {}) as $entry |

      # resolve soundfile: entry → default entry → hardcoded
      (($entry.soundfile // "default")
        | if . == "default" or . == "" then
            (($def.soundfile // "default")
              | if . == "default" or . == "" then $fallback_sound else . end)
          else . end) as $sf |

      # resolve blink_color: entry → default entry → hardcoded
      (($entry.blink_color // "default")
        | if . == "default" or . == "" then
            (($def.blink_color // "default")
              | if . == "default" or . == "" then $fallback_color else . end)
          else . end) as $bc |

      [$sound, $blink, $sf, $bc] | join("\n")
    ' "$GLOBAL_CONFIG" 2>/dev/null
) || RESOLVED=""

if [ -n "$RESOLVED" ]; then
    SOUND_ENABLED=$(sed -n '1p' <<< "$RESOLVED")
    BLINK_ENABLED=$(sed -n '2p' <<< "$RESOLVED")
    SOUNDFILE=$(sed -n '3p' <<< "$RESOLVED")
    BLINK_COLOR=$(sed -n '4p' <<< "$RESOLVED")
else
    SOUND_ENABLED="true"
    SOUNDFILE="$DEFAULT_SOUND"
    BLINK_ENABLED="true"
    BLINK_COLOR="$DEFAULT_COLOR"
fi

# --- Execute ---

if [ "$SOUND_ENABLED" = "true" ] && [ -f "$SOUNDFILE" ]; then
    $SOUND_PLAYER "$SOUNDFILE" &
fi

if [ "$BLINK_ENABLED" = "true" ] && [ -x "$FLASH_BIN" ]; then
    "$FLASH_BIN" --color "$BLINK_COLOR" --width 6 --hold 0.4 --fade 0.3 &
fi

exit 0
